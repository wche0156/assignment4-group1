---
title: "research"
output: html_document
bibliography: references.bib 
date: '2022-05-20'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      message = FALSE, 
                      warning = FALSE,
                      comment = NA,
                      cache = TRUE)
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
# Libraries
library(tidyverse)
library(readr)
library(kableExtra)
library(bookdown)
library(tinytex)
library(rgdal)
library(broom)
library(sf)
library(gganimate)
library(transformr)
```


# Analysis

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# read data
daily_caloric_supply <- read_csv("Data/daily-caloric-supply-derived-from-carbohydrates-protein-and-fat.csv")
dietary_compositions <- read_csv("Data/dietary-compositions-by-commodity-group.csv")
overweight_calories <- read_csv("Data/share-of-adult-men-overweight-or-obese-vs-daily-supply-of-calories.csv")
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
# data wrangling
daily_caloric_supply <- daily_caloric_supply %>%
  rename_all(str_remove, pattern = "\\(FAO.+\\)") %>%
  select(-Code)

dietary_compositions <- dietary_compositions %>%
  rename_all(str_remove, pattern = "\\(FAO.+\\)") %>%
  select(-Code)
```


```{r fig-1, echo = FALSE, message = FALSE, warning = FALSE, out.width = '75%', fig.align = "center", fig.width = 8, fig.cap ="Kilocalories per Person per Day in Australia"}
# data figure1
figure1 <- dietary_compositions %>% 
  filter(Entity == 'Australia') %>% 
  pivot_longer(cols = -c(Entity,Year),
               names_to = 'Variable',
               values_to = 'Value') %>% 
  ggplot(aes(x = Year,
             y = Value,
             fill = Variable)) +
  geom_area(color = 'white') +
  scale_fill_viridis_d() +
  labs(y = 'Kilocalories per Person per Day',
       title = 'Kilocalories per Person per Day in Australia') +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = 'bottom',
        text = element_text(size = 8)) +
  transition_reveal(Year)

figure1
animate(figure1,
        res = 300,
        width = 2000,
        height = 1125,
        renderer = gifski_renderer())
anim_save("figure1.gif")
```


# Data Explanation
According to (Figure\@ref(fig:fig-1)), we can see the different colours represent different food groups and the larger the area, the greater the proportion of the Australian diet. It is clear that they prefer cereals and grains, meat, fats and sugary foods to pulses and starchy roots.


# Reference
According to the Australian government's dietary guidelines, these unhealthy diets have led to many Australian adults and about a quarter of children being overweight or obese, so it's time to make changes for the sake of our health @grech2018macronutrient.


```{r fig-2, echo = FALSE, message = FALSE, warning = FALSE, out.width = '75%', fig.align = "center", fig.width = 8, fig.cap ="Year: {closest_state}"}
# read world map data
world <- readOGR(dsn = 'World_Countries_(Generalized)/.')
world_shp <- world %>% 
  st_as_sf()
world_data <- daily_caloric_supply %>%
  select(Entity, Year, `Calories from animal protein `) %>%
  merge(world_shp,
        by.x = "Entity",
        by.y = "COUNTRY") %>% 
  st_as_sf()

# data figure2
figure2 <- world_data %>%
  ggplot(aes(fill = `Calories from animal protein `)) +
  geom_sf(colour = NA) +
  labs(x = 'Longitude',
       y = 'Latitude',
       title = '  Year: {closest_state}') +
  scale_fill_viridis_c(na.value = 'grey') +
  theme_void() +
  theme(legend.position = 'bottom') +
  transition_states(states = Year)
figure2
animate(figure2,
        res = 300,
        width = 2000,
        height = 1125)
anim_save('figure2.gif')
```


# Data Explanation
To better represent the variation in calories provided by animal protein around the world, I first downloaded data from a world map online, then matched it to the dataset I chose by country name, then filled in the colours according to the calories provided by animal protein to create (Figure\@ref(fig:fig-2)). The closer the color is to green, the more calories from animal protein, and conversely the closer the color is to blue the less there is. Overall, the amount of calories from animal protein has increased worldwide.


# Reference
Observing the (Figure\@ref(fig:fig-2)) we can find that people living in North America, Oceania, and Europe consume more animal protein to provide calories, simply put, their diet composition prefers meat products, but also from the side to reflect the continued high consumption of livestock products in almost all developed countries  @stoll2015sustainability.


```{r, echo = FALSE, message = FALSE, warning = FALSE}
# data wrangling
by_entity <- overweight_calories %>% 
  rename('caloric_supply' = 'Daily caloric supply (OWID based on UN FAO & historical sources)',
         'Overweight' = 'Overweight or Obese (NCDRisC (2017))') %>% 
  select(Entity, Year, caloric_supply, Overweight) %>%
  filter(Entity %in% c("Australia", "China",
                       "United States", "United Kingdom",
                       "South Africa", "Brazil"),
         Year >= 2000) %>%
  drop_na()
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
# linear models
by_entity2 <- by_entity %>%
  group_by(Entity)%>%
  nest()

fit_lm <- function(x){
  lm(Overweight~caloric_supply, data = x)
}
mapped_lm <- map(by_entity$data, fit_lm)
```


```{r show-good-fit}
ggplot(data = by_entity,
       aes(x = caloric_supply, 
           y = Overweight)) + 
         geom_point(alpha = 0.4) +
  facet_wrap(~Entity, scales = "free") +
  geom_smooth(method = "lm")
```


```{r}
entity_model <- by_entity2 %>% 
                    mutate(model = map(data, function(x){
                      lm(Overweight~caloric_supply, data = x)
                      })
                      )

entity_model %>%
  mutate(tidy = map(model, tidy))
```


```{r map-tidy-model, echo = FALSE, message = FALSE, warning = FALSE}
entity_coefs <- entity_model %>%
                    mutate(tidy = map(model, tidy)) %>%
                    unnest(tidy) %>%
                    select(Entity, term, estimate)
```


```{r tidy-unnested-coefs, echo = FALSE, message = FALSE, warning = FALSE}
tidy_entity_coefs <- entity_coefs %>%
                          pivot_wider(id_cols = c(Entity), 
                                      names_from =  term,
                                      values_from = estimate) %>%
                          rename(Intercept = `(Intercept)`,
                                 Slope = caloric_supply)
```


```{r glance-country}
entity_glance <- entity_model %>% 
  mutate(glance = map(model, glance)) %>%
  unnest(glance) %>%
  select(Entity, r.squared, AIC, BIC)
```


```{r table, echo = FALSE, message = FALSE, warning = FALSE}
Table1 = entity_glance
knitr::kable(Table1, booktabs = TRUE, "html",
             caption = "Goodness_of_fit_measures") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```


# Data Explanation
Figure \@ref(fig:show-good-fit) shows that the Chinese fitted linear model is the best, while, according to (Table\@ref(tab:table-1)), we can find that Chinese linear model has a maximum r.squared value around 0.97 and there are relatively small AIC and BIC values of around 46.42 and 48.55 respectively. Therefore, we can find that Chinese people's overweight or obese are more affected by calorie intake.


# Referencing
R-squared is the percentage of outcome variable variation explained by the model, and describes how close the data are to the fitted regression. In general, the higher the R-squared value, the better the model fits. AIC and BIC both aim at achieving a compromise between model goodness of fit and model complexity. The preferred models are those with minimum AIC/BIC(@yang2015model). 


